name: Update Docs

on:
  workflow_call:
    inputs:
      docs_path:
        description: 'Path to docs directory'
        required: false
        default: 'docs/'
        type: string
      mode:
        description: 'Update mode: affected (uses doctrace), all (brute-force), or custom'
        required: false
        default: 'affected'
        type: string
      custom_skill:
        description: 'Path to custom skill file in caller repo (used when mode=custom)'
        required: false
        default: '.claude/commands/update-docs.md'
        type: string
      auto_merge_days:
        description: 'Auto-merge PR after N days (0 to disable)'
        required: false
        default: 3
        type: number
      git_ref:
        description: 'Git ref for smart mode (tag, branch, commit, or --since-lock)'
        required: false
        default: '--since-lock'
        type: string
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true

env:
  BASE_URL: https://raw.githubusercontent.com/lucasvtiradentes/doc-updater/main
  WORK_DIR: /tmp/doc-updater

jobs:
  update-docs:
    name: Update documentation
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install tools
        run: |
          npm install -g @anthropic-ai/claude-code
          pipx install doctrace

      - name: Download scripts
        run: |
          mkdir -p $WORK_DIR/commands
          curl -sL $BASE_URL/.github/scripts/run-claude.sh -o $WORK_DIR/run-claude.sh
          curl -sL $BASE_URL/.github/scripts/update-docs.sh -o $WORK_DIR/update-docs.sh
          chmod +x $WORK_DIR/*.sh

      - name: Setup skill
        run: |
          if [ "${{ inputs.mode }}" = "custom" ]; then
            if [ -f "${{ inputs.custom_skill }}" ]; then
              echo "Using custom skill from: ${{ inputs.custom_skill }}"
              cp "${{ inputs.custom_skill }}" $WORK_DIR/commands/update-docs.md
            else
              echo "ERROR: Custom skill not found at ${{ inputs.custom_skill }}"
              exit 1
            fi
          elif [ "${{ inputs.mode }}" = "affected" ]; then
            echo "Downloading affected skill (uses doctrace)..."
            curl -sL $BASE_URL/commands/update-docs-affected.md -o $WORK_DIR/commands/update-docs.md
          else
            echo "Downloading all skill (brute-force)..."
            curl -sL $BASE_URL/commands/update-docs-all.md -o $WORK_DIR/commands/update-docs.md
          fi

      - name: Update docs
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DOCS_PATH: ${{ inputs.docs_path }}
          GIT_REF: ${{ inputs.git_ref }}
          AUTO_MERGE_DAYS: ${{ inputs.auto_merge_days }}
          SCRIPT_DIR: ${{ env.WORK_DIR }}
        run: ${{ env.WORK_DIR }}/update-docs.sh

      - name: Upload sync report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: doc-sync-report
          path: .doctrace/syncs/
          if-no-files-found: ignore
          retention-days: 30
