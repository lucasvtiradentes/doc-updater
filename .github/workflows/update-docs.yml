name: Update Docs

on:
  workflow_call:
    inputs:
      docs_path:
        description: 'Path to docs directory'
        required: false
        default: 'docs/'
        type: string
      mode:
        description: 'Update mode: smart (uses doctrace), legacy (brute-force), or custom'
        required: false
        default: 'smart'
        type: string
      custom_skill:
        description: 'Path to custom skill file in caller repo (used when mode=custom)'
        required: false
        default: '.claude/commands/update-docs.md'
        type: string
      auto_merge_days:
        description: 'Auto-merge PR after N days (0 to disable)'
        required: false
        default: 3
        type: number
      git_ref:
        description: 'Git ref for smart mode (tag, branch, commit, or --since-lock)'
        required: false
        default: '--since-lock'
        type: string
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true

jobs:
  update-docs:
    name: Update documentation
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Download scripts
        run: |
          mkdir -p /tmp/doc-updater/skills
          curl -sL https://raw.githubusercontent.com/lucasvtiradentes/doc-updater/main/.github/scripts/run-claude.sh -o /tmp/doc-updater/run-claude.sh
          curl -sL https://raw.githubusercontent.com/lucasvtiradentes/doc-updater/main/.github/scripts/update-docs.sh -o /tmp/doc-updater/update-docs.sh
          chmod +x /tmp/doc-updater/*.sh

      - name: Setup skill
        run: |
          if [ "${{ inputs.mode }}" = "custom" ]; then
            if [ -f "${{ inputs.custom_skill }}" ]; then
              echo "Using custom skill from: ${{ inputs.custom_skill }}"
              cp "${{ inputs.custom_skill }}" /tmp/doc-updater/skills/update-docs.md
            else
              echo "ERROR: Custom skill not found at ${{ inputs.custom_skill }}"
              exit 1
            fi
          elif [ "${{ inputs.mode }}" = "smart" ]; then
            echo "Downloading smart skill..."
            curl -sL https://raw.githubusercontent.com/lucasvtiradentes/doc-updater/main/skills/update-docs-smart.md -o /tmp/doc-updater/skills/update-docs.md
          else
            echo "Downloading legacy skill..."
            curl -sL https://raw.githubusercontent.com/lucasvtiradentes/doc-updater/main/skills/update-docs-legacy.md -o /tmp/doc-updater/skills/update-docs.md
          fi

      - name: Update docs
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DOCS_PATH: ${{ inputs.docs_path }}
          GIT_REF: ${{ inputs.git_ref }}
          AUTO_MERGE_DAYS: ${{ inputs.auto_merge_days }}
          SCRIPT_DIR: /tmp/doc-updater
        run: /tmp/doc-updater/update-docs.sh
